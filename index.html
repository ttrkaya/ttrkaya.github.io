<html>
<head>
	<title> pinpon </title>
	<script>
		
		var utils = null;
		utils = {
			captureMouse: function() {
				window.mouseX = 0;
				window.mouseY = 0;
				window.isMouseDown = false;
				document.onmousemove = function(e) {
					window.mouseX = e.pageX;
					window.mouseY = e.pageY;
				};
				document.onmousedown = function(e) {
					window.isMouseDown = true;
				};
				document.onmouseup = function(e) {
					window.isMouseDown = false;
				};
			},
			frameCallback: null,
			listenFrame: function(callback) {
				utils.frameCallback = callback;
				utils.onEnterFrame();
			},
			onEnterFrame: function() {
				utils.frameCallback();
				requestAnimationFrame(utils.onEnterFrame);
			}
		};

var canvasContext = null;	

function Vec(x, y) {
	this.x = x || 0;
	this.y = y || 0;
};
Vec.prototype.copy = function() {
	return new Vec(this.x, this.y);
};
Vec.prototype.add = function(v) {
	this.x += v.x;
	this.y += v.y;
};
Vec.prototype.sub = function(v) {
	this.x -= v.x;
	this.y -= v.y;
};
Vec.prototype.scale = function(n) {
	this.x *= n;
	this.y *= n;
};
Vec.prototype.rotate = function(angle) {
	var tx = this.x;
	var ty = this.y;
	this.x = tx * Math.cos(angle) - ty * Math.sin(angle);
	this.y = ty * Math.cos(angle) + tx * Math.sin(angle);
};
Vec.prototype.toText = function() {
	return Math.round(this.x) + " : " + Math.round(this.y);
};

function clear(){
	canvasContext.clearRect(0,0,1000,1000);	
	canvasContext.fillStyle = "#cccccc";
	canvasContext.fillRect(0,0,1000,1000);
};

function write(v, text, color) {
	canvasContext.fillStyle = color || "#000000";
	canvasContext.fillText(text, v.x, v.y - 3);
};

function drawCircle(v, r, color) {
	canvasContext.fillStyle = color || "#000000";
	canvasContext.beginPath();
	canvasContext.arc(v.x, v.y, r, 0, 2*Math.PI);
	canvasContext.fill();
};

function drawLine(vBegin, vEnd, color) {
	canvasContext.strokeStyle = color || "#000000";
	canvasContext.beginPath();
	canvasContext.moveTo(vBegin.x, vBegin.y);
	canvasContext.lineTo(vEnd.x, vEnd.y);
	canvasContext.stroke();
};

const NUM_BALLS = 5;
const R = 15;
const BALL_SPEED = 3;
var ballPositions = [];
var ballVelocites = [];
for(var i=0; i<NUM_BALLS; i++){
	ballPositions.push(new Vec(Math.random()*400, Math.random()*400));
	ballVelocites.push(new Vec());
	var velAngle = Math.random() * 2 * Math.PI;
	ballVelocites[i].x = Math.cos(velAngle) * BALL_SPEED;
	ballVelocites[i].y = Math.sin(velAngle) * BALL_SPEED;
}

const wallEdgeY = 150;

function collideBalls(i, j){
	var p0 = ballPositions[i].copy();
	var p1 = ballPositions[j].copy();
	var v0 = ballVelocites[i].copy();
	var v1 = ballVelocites[j].copy();

	var dp = p1.copy(); dp.sub(p0);
	var angle = Math.atan2(dp.y, dp.x);
	var lv0 = v0.copy(); lv0.rotate(-angle);
	var lv1 = v1.copy(); lv1.rotate(-angle);

	var temp = lv0.x;
	lv0.x = lv1.x;
	lv1.x = temp;

	lv0.rotate(angle);
	lv1.rotate(angle);
	ballVelocites[i] = lv0;
	ballVelocites[j] = lv1;
};

function onEnterFrame() {
	for(var i=0; i<NUM_BALLS; i++){
		var ballPosition = ballPositions[i];
		var ballVelocity = ballVelocites[i];

		ballPosition.add(ballVelocity);

		if(ballPosition.x < R		&& ballVelocity.x < 0) ballVelocity.x *= -1;
		if(ballPosition.x > 400 - R	&& ballVelocity.x > 0) ballVelocity.x *= -1;
		if(ballPosition.y < R		&& ballVelocity.y < 0) ballVelocity.y *= -1;
		if(ballPosition.y > 400 - R	&& ballVelocity.y > 0) ballVelocity.y *= -1;

		var wallAngle = Math.atan2(wallEdgeY, 400);
		var localBallPos = ballPosition.copy(); 
		localBallPos.rotate(-wallAngle);
		var localBallVelocity = ballVelocity.copy();
		localBallVelocity.rotate(-wallAngle);

		if(localBallPos.y < R && localBallVelocity.y < 0) {
			localBallVelocity.y *= -1;
			ballVelocity = localBallVelocity;
			ballVelocity.rotate(wallAngle);
			ballVelocites[i] = ballVelocity;
		}

		for(var j=i+1; j<NUM_BALLS; j++) {
			var otherBallPosition = ballPositions[j];
			var otherBallVelocity = ballVelocites[j];
			var dx = ballPosition.x - otherBallPosition.x;
			var dy = ballPosition.y - otherBallPosition.y;
			var distanceSquared = dx*dx + dy*dy;
			if(distanceSquared < 4*R*R) {
				var dp = ballPosition.copy(); dp.sub(otherBallPosition);
				var dv = ballVelocity.copy(); dv.sub(otherBallVelocity);
				var ddot = dp.x * dv.x + dp.y * dv.y;
				if(ddot < 0) {
					collideBalls(i,j);
				}
			}
		}
	}

	clear();
	drawLine(new Vec(0, 0), new Vec(400, wallEdgeY), "#ff0000");
	for(var i=0; i<ballPositions.length; i++) drawCircle(ballPositions[i], 15, "#0000ff");
};

window.onload = function() {
	var canvas = document.getElementById("canvas");
	canvasContext = canvas.getContext("2d");
	canvasContext.font = "bold 20px Calibri";
	utils.captureMouse();
	utils.listenFrame(onEnterFrame);
};
	</script>
</head>
<body>
<canvas id="canvas" height="400" width="400"></canvas>
</body>